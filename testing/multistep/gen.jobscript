#!/bin/bash
#set -euo pipefail

echo "=== GEN job starting ==="
echo "Host: $(hostname)"
echo "PWD(cmd): $(/bin/pwd -P || pwd || true)"
echo "PWD(var): ${PWD:-unset}"
echo "JUSTIN_JOB_INDEX=${JUSTIN_JOB_INDEX:-unset}"
echo "JUSTIN_PATH=${JUSTIN_PATH:-unset}"

# ----------------------------------------------------------------------
# Get the allocated Monte Carlo "counter file" and remember it
# ----------------------------------------------------------------------
if [[ -z "${JUSTIN_PATH:-}" ]]; then
  echo "ERROR: JUSTIN_PATH is not set (job not running under justIN wrapper?)"
  exit 2
fi

alloc="$("$JUSTIN_PATH/justin-get-file")"
if [[ -z "$alloc" ]]; then
  echo "No more inputs allocated (workflow complete). Exiting cleanly."
  exit 0
fi

did="$(echo "$alloc" | awk '{print $1}')"
pfn="$(echo "$alloc" | awk '{print $2}')"
rse="$(echo "$alloc" | awk '{print $3}')"
echo "Allocated input: did=$did pfn=$pfn rse=$rse"

# Use the job index for naming (or derive from pfn if you prefer)
JOB_INDEX="${JUSTIN_JOB_INDEX:-0}"

# ----------------------------------------------------------------------
# Use this to set any environment variables we want
# ----------------------------------------------------------------------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
source "${SCRIPT_DIR}/params/gen.env"

if [[ -z "${JOB_FHICL_FILE:-}" ]]; then
  echo "ERROR: JOB_FHICL_FILE is not set (job not running under justIN wrapper?)"
  exit 2
fi

# ----------------------------------------------------------------------
# Environment setup
# ----------------------------------------------------------------------
echo "Sourcing DUNE setup..."
# setup_dune.sh can reference unset vars, so disable nounset only while sourcing

source /cvmfs/dune.opensciencegrid.org/products/dune/setup_dune.sh

setup dunesw v10_16_00d00 -q e26:prof

ups active
lar --version

# ----------------------------------------------------------------------
# Point fhicl to our local files
# ----------------------------------------------------------------------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
export FHICL_FILE_PATH="${SCRIPT_DIR}/fhicl:${FHICL_FILE_PATH:-.}"

# ----------------------------------------------------------------------
# Run GEN
# ----------------------------------------------------------------------
FCL=${JOB_FHICL_FILE} 
NEVENTS=20
OUTFILE="muminus_${did}_gen.root"

echo "Running lar GEN:"
echo "  FCL: ${FCL}"
echo "  Events: ${NEVENTS}"
echo "  Output: ${OUTFILE}"

lar -c "${FCL}" -n "${NEVENTS}" -o "${OUTFILE}"

# ----------------------------------------------------------------------
# Sanity checks
# ----------------------------------------------------------------------
test -f "${OUTFILE}" || { echo "ERROR: ${OUTFILE} not produced"; exit 1; }
ls -lh "${OUTFILE}"

# ----------------------------------------------------------------------
# Tell justIN we successfully processed the allocated input
# ----------------------------------------------------------------------
echo "$did" >> justin-processed-dids.txt
# (Alternative: echo "$pfn" >> justin-processed-pfns.txt)

echo "Wrote processed DID to justin-processed-dids.txt: $did"
echo "=== GEN job completed successfully ==="
