#!/bin/bash
#set -euo pipefail

echo "=== GEN job starting ==="
echo "Host: $(hostname)"
echo "PWD(cmd): $(/bin/pwd -P || pwd || true)"
echo "PWD(var): ${PWD:-unset}"
echo "JUSTIN_JOB_INDEX=${JUSTIN_JOB_INDEX:-unset}"

# Make test mode work even if JUSTIN_JOB_INDEX isn't set
JOB_INDEX="${JUSTIN_JOB_INDEX:-0}"

# ----------------------------------------------------------------------
# Environment setup
# ----------------------------------------------------------------------
source /cvmfs/dune.opensciencegrid.org/products/dune/setup_dune.sh
setup dunesw v10_16_00d00 -q e26:prof

ups active
lar --version

# ----------------------------------------------------------------------
# Run GEN
# ----------------------------------------------------------------------
FCL="prod_muminus_0.1-5.0GeV_isotropic_dune10kt_1x2x6.fcl"
NEVENTS=20
OUTFILE="gen_${JOB_INDEX}.root"

echo "Running lar GEN:"
echo "  FCL: ${FCL}"
echo "  Events: ${NEVENTS}"
echo "  Output: ${OUTFILE}"

lar -c "${FCL}" -n "${NEVENTS}" -o "${OUTFILE}"

# ----------------------------------------------------------------------
# Sanity checks
# ----------------------------------------------------------------------
if [[ ! -f "${OUTFILE}" ]]; then
  echo "ERROR: Output file ${OUTFILE} not produced!"
  exit 1
fi

ls -lh "${OUTFILE}"

# Register output for next stage
justin-output "${OUTFILE}"

echo "=== GEN job completed successfully ==="
